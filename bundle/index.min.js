'use strict';

/**
 * @Author: St. <SuperMoo>
 * @Date:   2016-01-27-17.14
 *          2016-02-13-08.36
 *          2016-02-14-21.06
 * @Email:  st_sister@me.com
 * @Filename: app.js
* @Last modified by:   SuperMoo
* @Last modified time: 2017-02-06-15:30:07
 * @License: MIT
 */

$(function () {
    var defaultText = {
        from: '阿木',
        to: '-阿紫～',
        wish: '情人节快乐！'
    };

    var hashHandler = function hashHandler() {
        var href = window.location.href;
        href = decodeURI(href);
        console.log(href);
        var array = [];
        if (href.indexOf('?') !== 0) {
            array = href.split('?');
            array = array[1].split(',');
        }

        console.log(array);

        var from = array[0] || defaultText.from;
        var to = array[1] || defaultText.to;
        var wish = array[2] || defaultText.wish;

        return {
            from: from,
            to: to,
            wish: wish
        };
    };

    var d = new Date();
    var year = d.getFullYear();

    var dom = [{
        name: 'section5',
        text: '\n        <div class="sectionIn">\n            <p>\n                \u732E\u7ED9<span id="hashTo"></span>, <br>\n                <span id="hashWish"></span><br>\n                \u6765\u81EA<span id="hashFrom"></span><br>\n                ' + year + '-02-14\n            </p>\n            <img src="img/qrcode.gif" width="220" height="220" class="qrcode" /> \u626B\u7801\u6216\u5FAE\u4FE1\u957F\u6309\u4E8C\u7EF4\u7801\u5206\u4EAB <br>\n            <div class="license">\n                \uFF0F\u540E\u9762\u8FD8\u6709\u54E6\uFF0F\n            </div>\n        </div>\n        '
    }, {
        name: 'section5',
        text: '\n        <div class="sectionIn">\n            <div class="btn2">\n                <a href="do.html">\n                \u6211\u4E5F\u60F3\u5236\u4F5C\u4E00\u4E2A</a>\n                </div>\n            </div>\n            <div class="btn">\n                <a href="https://github.com/superwoods">\n                \u8BBF\u95EE\u8D85\u7EA7\u6728\u6728\u7684Github\u9996\u9875</a>\n            </div>\n            <div class="license">\n                <a href="https://github.com/superwoods">\n                \u672C\u9875\u9762\u7531 / \u8D85\u7EA7\u6728\u6728 / \u6728Studio \u8BBE\u8BA1\u5236\u4F5C,\n                \u6211\u4EEC\u4F7F\u7528MIT\u5F00\u6E90\u534F\u8BAE, \u6B22\u8FCE\u8F6C\u8F7D\u5206\u4EAB,\n                \u4F46\u8BF7\u60A8\u52A1\u5FC5\u4FDD\u7559\u6211\u4EEC\u7684\u7F72\u540D, \u611F\u8C22\uFF01</a>\n            </div>\n        </div>\n        '
    }];

    // section5 & section6 添加dom
    $('#section5')[0].innerHTML = dom[0].text;
    $('#section6')[0].innerHTML = dom[1].text;

    var text = hashHandler();

    console.log(text);

    $('#hashTo').text(text.to);
    $('#hashWish').text(text.wish);
    $('#hashFrom').text(text.from);
    $('#title').text(text.to + text.wish);
    // $('title').append($('#hashTo').text() + '--来自' + $('#hashFrom').text());

    // 添加 jplayer 播放控件 dom
    $('body').append('<div id="jquery_jplayer_1" class="jp-jplayer"></div>' + '<div id="jp_container_1" class="jp-audio" role="application" aria-label="media player">' + '<button class="jp-play iconPlay" role="button" tabindex="0">play</button>' + '</div>');
    // 初始化 jPlayer
    $("#jquery_jplayer_1").jPlayer({
        ready: function ready(event) {
            $(this).jPlayer("setMedia", {
                mp3: 'media/Shayne-Ward-Until-You.mp3'
            });
            // 设置自动播放，iOS safari 受安全限制无效，wechat可以自动播放
            $(this).jPlayer("repeat");
            // $(this).jPlayer("play").jPlayer("repeat");
        },
        //swfPath: "js",
        supplied: "mp3",
        wmode: "window",
        useStateClassSkin: true,
        autoBlur: false,
        smoothPlayBar: true,
        keyEnabled: true,
        remainingDuration: true,
        toggleDuration: true,
        volume: 1
    });
});

// 当页面加载完毕时开始动画。
window.onload = function () {
    ani.init();
    updateSliderControl();
    addSmoothScrolling();
};

// 使用 onscroll 回调函数来更新 slider
window.onscroll = function () {
    updateSliderControl();
};

var ani = {
    init: function init() {
        this.logo("#hvd");
        this.logo("#ani1");
        this.logo("#ani2");
        this.logo("#ani3");
    },
    logo: function logo(tag) {
        TweenMax.fromTo(tag, 2, {
            // from
            css: {
                y: 0
            }
        }, {
            // to
            css: {
                y: "30px"
            },
            // 永久重复动画的选项
            repeat: -1,
            // 反转、重新运行动画的选项
            yoyo: true,
            // 改变 easing 类型
            ease: Sine.easeInOut
        });
    } //,
};

function updateSliderControl() {
    // 获得所有的 slider 链接
    var links = document.querySelectorAll("#slider-control a");
    for (var i = 0; i < links.length; i++) {
        var link = links[i];
        //console.log(link);
        var attr = link.getAttribute('href');
        // 获取被链接指向的部分
        var section = document.querySelector(attr);
        var sectionTop = section.offsetTop;
        var sectionBottom = sectionTop + window.innerHeight; //  section.offsetHeight
        // 检查 window.scrollY 是否在这部分中
        if (window.scrollY >= sectionTop && window.scrollY < sectionBottom) {
            //console.log(attr);
            link.className = "active";
            //event.preventDefault();
            //location.hash = attr;
            //console.log(link);
        } else {
            link.className = "";
        }
    }
}

// 网页滚动动画
function scrollToElement(element) {
    //声明变量topOfElement = element.offsetTop
    var topOfElement = element.offsetTop;
    // window 的动画滚动，使用TweenMax plugins
    TweenMax.to(window, 1, {
        scrollTo: {
            y: topOfElement
        },
        ease: Sine.easeInOut
    });
}

function addSmoothScrolling() {
    var links = document.querySelectorAll("#slider-control a");
    for (var i = 0; i < links.length; i++) {
        var link = links[i];
        //if (typeof window.addEventListener === 'function'){
        // 闭包
        (function (_link) {
            //console.log('_link: ' + _link);
            //console.log(link);
            link.addEventListener('click', function (event) {
                /*
                  这里禁用了鼠标的点击事件, 会导致hash无法更新，
                  也就是说hash就没有作用了
                  动画是否可以考虑换一种逻辑方式，
                  利用hash的方式去执行窗体混动的动画呢？？？
                */
                event.preventDefault();
                var attr = _link.getAttribute('href');
                //console.log('href: ' + _link);
                scrollToElement(document.querySelector(attr));
                //location.hash = attr;
            });
        })(link);
    }
}
